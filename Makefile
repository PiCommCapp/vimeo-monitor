.DEFAULT_GOAL := help

.PHONY: help
help: ## Show this help message
	@echo "üîß Vimeo Monitor - Available Commands"
	@echo "====================================="
	@echo ""
	@echo "üì¶ Installation & Setup:"
	@echo "  setup                Complete setup: check status, install dependencies, and verify"
	@echo "  setup-service        Complete setup including system service installation"
	@echo "  install              Install the virtual environment and dependencies"
	@echo "  install-uv           Install uv package manager"
	@echo "  status               Check installation status of key components"
	@echo ""
	@echo "üîß Service Management:"
	@echo "  install-service      Install Vimeo Monitor as a system service (requires sudo)"
	@echo "  uninstall-service    Uninstall Vimeo Monitor system service (requires sudo)"
	@echo "  service-start        Start the Vimeo Monitor service"
	@echo "  service-stop         Stop the Vimeo Monitor service"
	@echo "  service-restart      Restart the Vimeo Monitor service"
	@echo "  service-status       Check the status of the Vimeo Monitor service"
	@echo "  service-logs         View service logs"
	@echo "  verify-metrics       Verify Prometheus metrics installation and accessibility"
	@echo "  install-logrotate    Install system logrotate configuration (requires sudo)"
	@echo "  test-logrotate       Test logrotate configuration without actually rotating"
	@echo "  force-logrotate      Force log rotation now (for testing)"
	@echo ""
	@echo "üìã Development & Testing:"
	@echo "  test                 Run tests with pytest"
	@echo "  test-network         Run network monitoring tests"
	@echo "  test-performance     Test performance optimization functionality"
	@echo "  test-tui             Test TUI installation and functionality"
	@echo "  tui                  Launch the Terminal User Interface (TUI)"
	@echo "  tui-dev              Launch TUI in development mode with debug logging"
	@echo "  benchmark-performance Run performance benchmarks"
	@echo "  performance-status   Show current performance metrics"
	@echo "  clear-caches         Clear all application caches"
	@echo "  lint                 Run code linting checks"
	@echo "  format               Format code using ruff"
	@echo "  check                Run all checks (linting and tests)"
	@echo "  clean                Clean up build artifacts and cache files"
	@echo "  build                Build the project package"
	@echo ""
	@echo "üìä Log Management:"
	@echo "  analyze-logs         Analyze log files and show statistics"
	@echo "  compress-logs        Compress old log files to save space"
	@echo "  rotate-logs          Manually rotate current log file"
	@echo "  clean-logs           Clean old log files (keep current log)"
	@echo "  clean-old-logs       Clean log files older than 30 days"
	@echo ""
	@echo "üìö Documentation:"
	@echo "  docs                 Build documentation"
	@echo "  serve-docs           Serve documentation locally"
	@echo "  help                 Show this help message"
	@echo ""
	@echo "üîß Other:"
	@echo "  update-deps          Update project dependencies"
	@echo ""
	@echo "üí° Quick Start:"
	@echo "  ‚Ä¢ Development:     make setup"
	@echo "  ‚Ä¢ With Service:    make setup-service"
	@echo "  ‚Ä¢ Check Status:    make status"
	@echo "  ‚Ä¢ Run Tests:       make test"
	@echo "  ‚Ä¢ View Logs:       make service-logs"
	@echo ""

.PHONY: install-uv
install-uv: ## Install uv package manager
	@echo "üîç Checking for uv installation..."
	@if command -v uv >/dev/null 2>&1; then \
		echo "‚úÖ uv is already installed: $$(uv --version)"; \
	else \
		echo "üöÄ Installing uv package manager..."; \
		curl -LsSf https://astral.sh/uv/install.sh | sh; \
		echo "‚úÖ uv installation completed"; \
	fi

.PHONY: install
install: ## Install the virtual environment and dependencies
	@echo "üîç Checking for uv installation..."
	@if ! command -v uv >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è  uv not found, installing automatically..."; \
		$(MAKE) install-uv; \
	else \
		echo "‚úÖ uv is available: $$(uv --version)"; \
	fi
	@echo "üöÄ Creating virtual environment and installing dependencies"
	@uv sync
	@echo "üìã Installing logrotate configuration..."
	@if [ ! -f services/logrotation.conf ]; then \
		echo "‚ùå Error: services/logrotation.conf not found"; \
		exit 1; \
	fi
	@sudo cp services/logrotation.conf /etc/logrotate.d/vimeo-monitor
	@sudo chmod 644 /etc/logrotate.d/vimeo-monitor
	@echo "‚úÖ Logrotate configuration installed to /etc/logrotate.d/vimeo-monitor"
	@echo "üìù Note: Adjust log file paths in the configuration as needed"

.PHONY: install-service
install-service: ## Install Vimeo Monitor as a system service (requires sudo)
	@echo "üöÄ Installing Vimeo Monitor as system service..."
	@if [ ! -f scripts/install-service.sh ]; then \
		echo "‚ùå Error: scripts/install-service.sh not found"; \
		exit 1; \
	fi
	@if [ ! -f services/vimeo-monitor.service ]; then \
		echo "‚ùå Error: services/vimeo-monitor.service not found"; \
		exit 1; \
	fi
	@echo "‚ö†Ô∏è  This will install the service to run at boot automatically"
	@echo "üìç Installation directory: /opt/vimeo-monitor"
	@echo "üë§ Service will run as user: vimeo-monitor"
	@echo ""
	@./scripts/install-service.sh

.PHONY: uninstall-service
uninstall-service: ## Uninstall Vimeo Monitor system service (requires sudo)
	@echo "üóëÔ∏è  Uninstalling Vimeo Monitor system service..."
	@if [ ! -f scripts/uninstall-service.sh ]; then \
		echo "‚ùå Error: scripts/uninstall-service.sh not found"; \
		exit 1; \
	fi
	@./scripts/uninstall-service.sh

.PHONY: service-status
service-status: ## Check the status of the Vimeo Monitor service
	@echo "üîç Checking Vimeo Monitor service status..."
	@if command -v systemctl >/dev/null 2>&1; then \
		echo "üìä Systemd Service Status:"; \
		sudo systemctl status vimeo-monitor --no-pager || true; \
		echo ""; \
		echo "üìà Prometheus Metrics Status:"; \
		if curl -s http://localhost:8000/metrics >/dev/null 2>&1; then \
			echo "‚úÖ Metrics endpoint accessible at http://localhost:8000/metrics"; \
			echo "üìä Sample metrics:"; \
			curl -s http://localhost:8000/metrics | head -5; \
		else \
			echo "‚ùå Metrics endpoint not accessible (service may not be running)"; \
		fi; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		echo "üìä launchd Service Status:"; \
		sudo launchctl list | grep vimeomonitor || echo "Service not found"; \
		echo ""; \
		echo "üìà Prometheus Metrics Status:"; \
		if curl -s http://localhost:8000/metrics >/dev/null 2>&1; then \
			echo "‚úÖ Metrics endpoint accessible at http://localhost:8000/metrics"; \
		else \
			echo "‚ùå Metrics endpoint not accessible (service may not be running)"; \
		fi; \
	else \
		echo "‚ö†Ô∏è  Service status check not supported on this platform"; \
	fi

.PHONY: service-start
service-start: ## Start the Vimeo Monitor service
	@echo "‚ñ∂Ô∏è  Starting Vimeo Monitor service..."
	@if command -v systemctl >/dev/null 2>&1; then \
		sudo systemctl start vimeo-monitor; \
		echo "‚úÖ Service started"; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		sudo launchctl load /Library/LaunchDaemons/com.vimeomonitor.service.plist; \
		echo "‚úÖ Service started"; \
	else \
		echo "‚ö†Ô∏è  Service start not supported on this platform"; \
	fi

.PHONY: service-stop
service-stop: ## Stop the Vimeo Monitor service
	@echo "‚èπÔ∏è  Stopping Vimeo Monitor service..."
	@if command -v systemctl >/dev/null 2>&1; then \
		sudo systemctl stop vimeo-monitor; \
		echo "‚úÖ Service stopped"; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		sudo launchctl unload /Library/LaunchDaemons/com.vimeomonitor.service.plist; \
		echo "‚úÖ Service stopped"; \
	else \
		echo "‚ö†Ô∏è  Service stop not supported on this platform"; \
	fi

.PHONY: service-restart
service-restart: ## Restart the Vimeo Monitor service
	@echo "üîÑ Restarting Vimeo Monitor service..."
	@if command -v systemctl >/dev/null 2>&1; then \
		sudo systemctl restart vimeo-monitor; \
		echo "‚úÖ Service restarted"; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		sudo launchctl unload /Library/LaunchDaemons/com.vimeomonitor.service.plist || true; \
		sudo launchctl load /Library/LaunchDaemons/com.vimeomonitor.service.plist; \
		echo "‚úÖ Service restarted"; \
	else \
		echo "‚ö†Ô∏è  Service restart not supported on this platform"; \
	fi

.PHONY: service-logs
service-logs: ## View service logs
	@echo "üìã Viewing Vimeo Monitor service logs..."
	@if command -v systemctl >/dev/null 2>&1; then \
		echo "Use Ctrl+C to exit log viewing"; \
		sudo journalctl -u vimeo-monitor -f; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		if [ -f /opt/vimeo-monitor/logs/service.log ]; then \
			echo "Use Ctrl+C to exit log viewing"; \
			tail -f /opt/vimeo-monitor/logs/service.log; \
		else \
			echo "‚ùå Log file not found: /opt/vimeo-monitor/logs/service.log"; \
		fi \
	else \
		echo "‚ö†Ô∏è  Service logs not supported on this platform"; \
	fi

.PHONY: install-logrotate
install-logrotate: ## Install system logrotate configuration (requires sudo)
	@echo "üìã Installing logrotate configuration..."
	@if [ ! -f services/logrotation.conf ]; then \
		echo "‚ùå Error: services/logrotation.conf not found"; \
		exit 1; \
	fi
	@sudo cp services/logrotation.conf /etc/logrotate.d/vimeo-monitor
	@sudo chmod 644 /etc/logrotate.d/vimeo-monitor
	@echo "‚úÖ Logrotate configuration installed to /etc/logrotate.d/vimeo-monitor"
	@echo "üìù Note: Adjust log file paths in the configuration as needed"

.PHONY: test-logrotate
test-logrotate: ## Test logrotate configuration without actually rotating
	@echo "üß™ Testing logrotate configuration..."
	@sudo logrotate -d /etc/logrotate.d/vimeo-monitor

.PHONY: force-logrotate
force-logrotate: ## Force log rotation now (for testing)
	@echo "üîÑ Forcing log rotation..."
	@sudo logrotate -f /etc/logrotate.d/vimeo-monitor

.PHONY: clean-logs
clean-logs: ## Clean old log files (keep current log)
	@echo "üßπ Cleaning old log files..."
	@find ./logs -name "*.log.*" -type f -delete 2>/dev/null || true
	@find ./logs -name "*.log.*.gz" -type f -delete 2>/dev/null || true
	@echo "‚úÖ Old log files cleaned"

.PHONY: analyze-logs
analyze-logs: ## Analyze log files and show statistics
	@echo "üìä Analyzing log files..."
	@uv run python services/log_management.py analyze

.PHONY: compress-logs
compress-logs: ## Compress old log files to save space
	@echo "üóúÔ∏è Compressing log files..."
	@uv run python services/log_management.py compress

.PHONY: rotate-logs
rotate-logs: ## Manually rotate current log file
	@echo "üîÑ Rotating log files..."
	@uv run python services/log_management.py rotate

.PHONY: clean-old-logs
clean-old-logs: ## Clean log files older than 30 days
	@echo "üßπ Cleaning old log files (30+ days)..."
	@uv run python services/log_management.py clean --days 30

.PHONY: clean
clean: ## Clean up build artifacts and cache files
	@echo "üßπ Cleaning up..."
	@rm -rf build/ dist/ *.egg-info .coverage .pytest_cache .mypy_cache .ruff_cache
	@find . -type d -name "__pycache__" -exec rm -rf {} +
	@find . -type f -name "*.pyc" -delete

.PHONY: test
test: ## Run tests with pytest
	@echo "üß™ Running tests..."
	@uv run pytest tests/ -v

.PHONY: test-network
test-network: ## Run network monitoring tests
	@echo "üß™ Running network monitoring tests..."
	@uv run python test_network_monitoring.py

.PHONY: test-performance
test-performance: ## Test performance optimization functionality
	@echo "üß™ Testing performance optimization..."
	@uv run python test_performance_optimization.py

.PHONY: benchmark-performance
benchmark-performance: ## Run performance benchmarks
	@echo "üìä Running performance benchmarks..."
	@echo "This will run the application with performance monitoring for 2 minutes..."
	@timeout 120 uv run -m vimeo_monitor.monitor || echo "Benchmark completed"

.PHONY: performance-status
performance-status: ## Show current performance metrics
	@echo "üìà Performance Status:"
	@echo "Memory usage:"
	@python -c "import psutil; print(f'  CPU: {psutil.cpu_percent()}%'); print(f'  Memory: {psutil.virtual_memory().percent}%')"
	@echo "Disk usage:"
	@df -h . | tail -1 | awk '{print "  Disk: " $$5 " used"}'

.PHONY: clear-caches
clear-caches: ## Clear all application caches
	@echo "üßπ Clearing application caches..."
	@python -c "\
import sys, os; \
sys.path.insert(0, '.'); \
try: \
    from vimeo_monitor.performance import IntelligentCache; \
    cache = IntelligentCache(); \
    cache.clear(); \
    print('‚úÖ Caches cleared'); \
except ImportError: \
    print('‚ö†Ô∏è  Performance module not available'); \
except Exception as e: \
    print(f'‚ùå Error clearing caches: {e}')"

.PHONY: metrics-server
metrics-server: ## Start Prometheus metrics server (standalone)
	@echo "üìä Starting Prometheus metrics server..."
	@echo "Metrics will be available at: http://localhost:8000/metrics"
	@uv run python -c "\
from vimeo_monitor.metrics import PrometheusMetrics; \
import time; \
metrics = PrometheusMetrics(enable_metrics=True, metrics_port=8000); \
metrics.start_metrics_server(); \
print('Metrics server started. Press Ctrl+C to stop...'); \
try: \
    while True: \
        time.sleep(1); \
except KeyboardInterrupt: \
    print('\\nStopping metrics server...'); \
    metrics.stop_metrics_server(); \
    print('Metrics server stopped')"

.PHONY: test-metrics
test-metrics: ## Test Prometheus metrics collection
	@echo "üß™ Testing Prometheus metrics..."
	@uv run python -c "\
from vimeo_monitor.metrics import PrometheusMetrics; \
import time; \
print('Initializing metrics...'); \
metrics = PrometheusMetrics(enable_metrics=True, metrics_port=8001); \
metrics.start_metrics_server(); \
print('Recording test metrics...'); \
metrics.record_api_request('test_endpoint', 0.5, 'success'); \
metrics.record_cache_hit(); \
metrics.update_stream_status('test_stream', True); \
time.sleep(2); \
summary = metrics.get_metrics_summary(); \
print('Metrics summary:', summary); \
exported = metrics.export_metrics(); \
print('Sample metrics output:'); \
print(exported[:500] + '...' if len(exported) > 500 else exported); \
metrics.stop_metrics_server(); \
print('‚úÖ Metrics test completed')"

.PHONY: verify-metrics
verify-metrics: ## Verify Prometheus metrics installation and configuration
	@echo "üîç Verifying metrics installation..."
	@if [ -f scripts/verify-metrics-installation.sh ]; then \
		sudo ./scripts/verify-metrics-installation.sh; \
	else \
		echo "‚ùå Verification script not found: scripts/verify-metrics-installation.sh"; \
		exit 1; \
	fi

.PHONY: metrics-status
metrics-status: ## Show current metrics endpoint status
	@echo "üìä Prometheus Metrics Status:"
	@echo "Checking metrics endpoint..."
	@curl -s http://localhost:8000/metrics | head -10 || echo "‚ùå Metrics server not running (start application or run 'make metrics-server')"
	@echo ""
	@echo "‚ÑπÔ∏è  To start metrics server: make metrics-server"
	@echo "‚ÑπÔ∏è  To test metrics: make test-metrics"
	@echo "‚ÑπÔ∏è  To verify installation: make verify-metrics"

.PHONY: lint
lint: ## Run code linting checks
	@echo "üîç Running linting checks..."
	@uv run ruff check .
	@uv run mypy vimeo_monitor

.PHONY: format
format: ## Format code using ruff
	@echo "‚ú® Formatting code..."
	@uv run ruff format .

.PHONY: docs
docs: ## Build documentation
	@echo "üìö Building documentation..."
	@uv run mkdocs build

.PHONY: serve-docs
serve-docs: ## Serve documentation locally
	@echo "üåê Serving documentation..."
	@uv run mkdocs serve

.PHONY: update-deps
update-deps: ## Update project dependencies
	@echo "üîÑ Updating dependencies..."
	@uv pip compile pyproject.toml -o requirements.txt
	@uv pip compile pyproject.toml --extra dev -o requirements-dev.txt

.PHONY: check
check: lint test ## Run all checks (linting and tests)

.PHONY: build
build: clean ## Build the project package
	@echo "üèóÔ∏è Building package..."
	@uv run python -m build

.PHONY: status
status: ## Check installation status of key components
	@echo "üîç System Status Check"
	@echo "======================"
	@printf "üì¶ uv package manager: "
	@if command -v uv >/dev/null 2>&1; then \
		echo "‚úÖ Installed ($$(uv --version))"; \
	else \
		echo "‚ùå Not installed (run 'make install-uv')"; \
	fi
	@printf "üêç Python virtual environment: "
	@if [ -d .venv ]; then \
		echo "‚úÖ Present"; \
	else \
		echo "‚ùå Missing (run 'make install')"; \
	fi
	@printf "üìã Dependencies: "
	@if [ -f uv.lock ]; then \
		echo "‚úÖ Lock file present"; \
	else \
		echo "‚ö†Ô∏è  No lock file (run 'make install')"; \
	fi
	@printf "üìù Log directory: "
	@if [ -d logs ]; then \
		echo "‚úÖ Present"; \
	else \
		echo "‚ö†Ô∏è  Missing (will be created automatically)"; \
	fi
	@printf "‚öôÔ∏è  Configuration: "
	@if [ -f .env ]; then \
		echo "‚úÖ .env file present"; \
	else \
		echo "‚ö†Ô∏è  Missing .env file (copy from .env.sample)"; \
	fi
	@printf "üîß System service: "
	@if command -v systemctl >/dev/null 2>&1; then \
		if systemctl is-enabled vimeo-monitor >/dev/null 2>&1; then \
			echo "‚úÖ Installed and enabled"; \
		else \
			echo "‚ùå Not installed (run 'make install-service')"; \
		fi; \
	elif [[ "$$OSTYPE" == "darwin"* ]]; then \
		if [ -f /Library/LaunchDaemons/com.vimeomonitor.service.plist ]; then \
			echo "‚úÖ Installed"; \
		else \
			echo "‚ùå Not installed (run 'make install-service')"; \
		fi; \
	else \
		echo "‚ö†Ô∏è  Service not supported on this platform"; \
	fi

.PHONY: setup
setup: ## Complete setup: check status, install dependencies, and verify
	@echo "üöÄ Starting complete setup..."
	@echo ""
	$(MAKE) status
	@echo ""
	@echo "üîß Installing dependencies..."
	$(MAKE) install
	@echo ""
	@echo "‚úÖ Setup complete! Running final status check..."
	@echo ""
	$(MAKE) status
	@echo ""
	@echo "üéâ Development setup complete!"
	@echo ""
	@echo "üìã Next steps:"
	@echo "  - Configure .env file with your Vimeo API credentials"
	@echo "  - Run 'uv run -m vimeo_monitor.monitor' to test manually"
	@echo "  - Run 'make install-service' to install as system service"
	@echo ""

.PHONY: setup-service
setup-service: ## Complete setup including system service installation
	@echo "üöÄ Starting complete setup with service installation..."
	@echo ""
	$(MAKE) setup
	@echo ""
	@echo "üîß Installing system service..."
	$(MAKE) install-service
	@echo ""
	@echo "‚úÖ Complete setup with service installation finished!"
	@echo ""

.PHONY: tui
tui: ## Launch the Terminal User Interface (TUI)
	@echo "üöÄ Starting Vimeo Monitor TUI..."
	@if [ -f scripts/vimeo-tui ]; then \
		./scripts/vimeo-tui --dev; \
	else \
		echo "‚ùå TUI script not found at scripts/vimeo-tui"; \
		exit 1; \
	fi

.PHONY: tui-dev
tui-dev: ## Launch TUI in development mode with debug logging
	@echo "üöÄ Starting TUI in development mode with debug logging..."
	@if [ -f scripts/vimeo-tui ]; then \
		./scripts/vimeo-tui --dev --log-level DEBUG; \
	else \
		echo "‚ùå TUI script not found at scripts/vimeo-tui"; \
		exit 1; \
	fi

.PHONY: test-tui
test-tui: ## Test TUI installation and functionality
	@echo "üß™ Testing TUI installation..."
	@if [ -f scripts/vimeo-tui ]; then \
		echo "‚úÖ TUI script found"; \
		./scripts/vimeo-tui --version; \
		echo "üìã TUI help:"; \
		./scripts/vimeo-tui --help | head -10; \
	else \
		echo "‚ùå TUI script not found at scripts/vimeo-tui"; \
		exit 1; \
	fi
