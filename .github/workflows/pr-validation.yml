name: PR Validation

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12, 3.13]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run linting (ruff)
      run: |
        uv run ruff check .

    - name: Run formatting check (black)
      run: |
        uv run black --check .

    - name: Run import sorting check (isort)
      run: |
        uv run isort --check-only .

    - name: Run type checking (mypy)
      run: |
        echo "Running type checking (non-blocking)..."
        uv run mypy src/ --ignore-missing-imports || echo "Type checking completed with warnings"
      continue-on-error: true

    - name: Run unit tests
      run: |
        uv run pytest tests/ -v --cov=src --cov-report=xml -m "not slow and not integration"

    - name: Run integration tests
      run: |
        uv run pytest tests/integration/ -v --cov=src --cov-append -m "integration"

    - name: Run error scenario tests
      run: |
        uv run pytest tests/error_scenarios/ -v --cov=src --cov-append -m "not slow"

    - name: Run documentation tests
      run: |
        uv run pytest tests/test_documentation.py -v --cov=src --cov-append

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
